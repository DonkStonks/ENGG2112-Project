import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import os

def plot_crop_dataset_heatmap():
    # Adjust the path to point to the dataset (one folder up)
    file_path = os.path.join(os.path.dirname(__file__), '..', 'Crop_recommendation.csv')

    # Load dataset
    df = pd.read_csv(file_path)

    # Drop completely empty or unnamed columns
    df = df.loc[:, ~df.columns.str.contains('^Unnamed')]

    # Replace inf/-inf with NaN and drop rows with any missing values
    df.replace([float('inf'), float('-inf')], pd.NA, inplace=True)
    df.dropna(inplace=True)

    # One-hot encode categorical columns if present (keep all categories)
    categorical_cols = df.select_dtypes(include=['object']).columns
    if not categorical_cols.empty:
        df_encoded = pd.get_dummies(df, columns=categorical_cols, drop_first=False)
    else:
        df_encoded = df.copy()

    # Drop constant columns (same value everywhere)
    df_encoded = df_encoded.loc[:, df_encoded.nunique() > 1]

    # Select numeric columns only
    numeric_df = df_encoded.select_dtypes(include=['number'])

    if numeric_df.empty:
        print("No usable numeric columns found after cleaning and encoding.")
        print("Check: Are all columns categorical or constant?")
        print("Columns detected after encoding:")
        print(df_encoded.columns)
        return

    # Compute correlation matrix
    corr_matrix = numeric_df.corr()

    # Plot heatmap
    plt.figure(figsize=(12, 10))
    sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', fmt=".2f", vmin=-1, vmax=1)
    plt.title('Feature Correlation Heatmap (Crop Recommendation Dataset)')
    plt.tight_layout()
    plt.show()

if __name__ == "__main__":
    plot_crop_dataset_heatmap()
